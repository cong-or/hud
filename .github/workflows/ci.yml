name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  format:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Install Rust nightly (for eBPF)
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rust-src

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install bpf-linker
        run: cargo install bpf-linker --locked

      # Workaround for bpf-linker LLVM library incompatibility
      # Recent Rust nightlies use linker scripts (.so files containing "INPUT(...)") instead
      # of direct symlinks to the LLVM shared library. bpf-linker v0.9.15 doesn't handle
      # linker scripts correctly, causing "file too short" errors when trying to load LLVM.
      # This creates a direct symlink to the actual LLVM .so file so bpf-linker can find it.
      # See: https://github.com/aya-rs/bpf-linker/issues/200
      - name: Fix LLVM symlink for bpf-linker
        run: |
          NIGHTLY_PATH=$(rustup toolchain list --verbose | grep nightly | grep -oP '/.*')
          if [ -f "$NIGHTLY_PATH/lib/libLLVM-21-rust-1.94.0-nightly.so" ] && [ ! -L "$NIGHTLY_PATH/lib/libLLVM-21-rust-1.94.0-nightly.so" ]; then
            rm "$NIGHTLY_PATH/lib/libLLVM-21-rust-1.94.0-nightly.so"
            ln -s "$NIGHTLY_PATH/lib"/libLLVM.so.21.*-rust-*.so "$NIGHTLY_PATH/lib/libLLVM-21-rust-1.94.0-nightly.so"
          fi

      - name: Build eBPF program
        run: cargo xtask build-ebpf

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install Rust nightly (for eBPF)
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rust-src

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install bpf-linker
        run: cargo install bpf-linker --locked

      # Workaround for bpf-linker LLVM library incompatibility
      # Recent Rust nightlies use linker scripts (.so files containing "INPUT(...)") instead
      # of direct symlinks to the LLVM shared library. bpf-linker v0.9.15 doesn't handle
      # linker scripts correctly, causing "file too short" errors when trying to load LLVM.
      # This creates a direct symlink to the actual LLVM .so file so bpf-linker can find it.
      # See: https://github.com/aya-rs/bpf-linker/issues/200
      - name: Fix LLVM symlink for bpf-linker
        run: |
          NIGHTLY_PATH=$(rustup toolchain list --verbose | grep nightly | grep -oP '/.*')
          if [ -f "$NIGHTLY_PATH/lib/libLLVM-21-rust-1.94.0-nightly.so" ] && [ ! -L "$NIGHTLY_PATH/lib/libLLVM-21-rust-1.94.0-nightly.so" ]; then
            rm "$NIGHTLY_PATH/lib/libLLVM-21-rust-1.94.0-nightly.so"
            ln -s "$NIGHTLY_PATH/lib"/libLLVM.so.21.*-rust-*.so "$NIGHTLY_PATH/lib/libLLVM-21-rust-1.94.0-nightly.so"
          fi

      - name: Build eBPF program
        run: cargo xtask build-ebpf

      - name: Run tests
        run: cargo test --workspace --all-features
